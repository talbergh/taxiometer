<!doctype html>
<html lang="de" class="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
    <meta name="theme-co      <!-- Onboarding Modal -->
      <dialog id="onboardingModal" class="modal">
        <form method="dialog" class="modal-card">
          <div id="onboardingStep1" class="onboarding-step">
            <h3>Willkommen bei TaxiOMeter</h3>
            <div class="onboarding-progress">
              <div class="progress-dot active"></div>
              <div class="progress-dot"></div>
              <div class="progress-dot"></div>
              <div class="progress-dot"></div>
            </div>
            <p>Dein professioneller GPS-Taxameter für präzise Fahrtenabrechnung.</p>
            <div class="actions">
              <button type="button" id="nextStep1" class="primary">Weiter <i class="fa-solid fa-arrow-right"></i></button>
            </div>
          </div>
          
          <div id="onboardingStep2" class="onboarding-step" style="display:none;">
            <h3>Standortzugriff</h3>
            <div class="onboarding-progress">
              <div class="progress-dot"></div>
              <div class="progress-dot active"></div>
              <div class="progress-dot"></div>
              <div class="progress-dot"></div>
            </div>
            <p>Für exakte Distanzmessung benötigen wir Zugriff auf deinen Standort. Dies wird nur während aktiver Fahrten verwendet.</p>
            <div class="actions">
              <button type="button" id="backStep2" class="ghost"><i class="fa-solid fa-arrow-left"></i> Zurück</button>
              <button type="button" id="requestLocation" class="primary">Zugriff erlauben</button>
            </div>
          </div>
          
          <div id="onboardingStep3" class="onboarding-step" style="display:none;">
            <h3>Tarif festlegen</h3>
            <div class="onboarding-progress">
              <div class="progress-dot"></div>
              <div class="progress-dot"></div>
              <div class="progress-dot active"></div>
              <div class="progress-dot"></div>
            </div>
            <p>Stelle deinen Preis pro Kilometer ein:</p>
            <div class="input-affix" style="margin: 16px 0;">
              <input id="onboardingRate" type="number" inputmode="decimal" min="0" step="0.01" placeholder="1.50" />
              <span class="affix">€/km</span>
            </div>
            <div class="actions">
              <button type="button" id="backStep3" class="ghost"><i class="fa-solid fa-arrow-left"></i> Zurück</button>
              <button type="button" id="nextStep3" class="primary">Weiter <i class="fa-solid fa-arrow-right"></i></button>
            </div>
          </div>
          
          <div id="onboardingStep4" class="onboarding-step" style="display:none;">
            <h3>Alles bereit!</h3>
            <div class="onboarding-progress">
              <div class="progress-dot"></div>
              <div class="progress-dot"></div>
              <div class="progress-dot"></div>
              <div class="progress-dot active"></div>
            </div>
            <div style="background: var(--bg-3); border-radius: 12px; padding: 16px; margin: 16px 0;">
              <h4 style="margin: 0 0 8px 0; color: var(--accent);">So funktioniert's:</h4>
              <ul style="margin: 0; padding-left: 20px; color: var(--text-2);">
                <li>Tippe auf "Start" und gib optional einen Fahrtnamen ein</li>
                <li>Die Karte zeigt deine Route in Echtzeit</li>
                <li>Nutze "Pause" für Wartezeiten</li>
                <li>Bei "Stop" erhältst du eine Zusammenfassung mit Rabattmöglichkeit</li>
              </ul>
            </div>
            <div class="actions">
              <button type="button" id="backStep4" class="ghost"><i class="fa-solid fa-arrow-left"></i> Zurück</button>
              <button type="button" id="finishOnboarding" class="success"><i class="fa-solid fa-check"></i> Los geht's!</button>
            </div>
          </div>
        </form>
      </dialog>#0b0f14" />
    <meta name="color-scheme" content="dark" />
    <meta name="description" content="TaxiOMeter von Talbergh – GPS-basierter Taxameter als mobile Web-App (PWA). Preis pro km festlegen, Fahrt starten, Route tracken, Preis berechnen." />
    <meta name="author" content="Talbergh" />
    <meta name="format-detection" content="telephone=no, date=no, email=no, address=no" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-title" content="TaxiOMeter" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="application-name" content="TaxiOMeter" />

    <title>TaxiOMeter · Talbergh</title>

    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 256 256'%3E%3Crect width='256' height='256' rx='56' fill='%230b0f14'/%3E%3Cpath d='M44 150a18 18 0 0 1 18-18h132a18 18 0 0 1 18 18v24a14 14 0 0 1-14 14h-6a18 18 0 0 1-18-18v-2H82v2a18 18 0 0 1-18 18h-6a14 14 0 0 1-14-14zm24-44 20-30a18 18 0 0 1 15-8h50a18 18 0 0 1 15 8l20 30z' fill='%23cfe6ff'/%3E%3Crect x='88' y='52' width='80' height='28' rx='6' fill='%23cfe6ff'/%3E%3C/svg%3E" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />

  <!-- Font Awesome (Free) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" referrerpolicy="no-referrer" />
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <link rel="stylesheet" href="./styles.css" />

    <script>
      // Generate manifest and Apple touch icon at runtime to avoid external assets while keeping PWA installability.
      (function generateManifestAndIcons() {
        try {
          const makeIcon = (size) => {
            const c = document.createElement('canvas');
            c.width = c.height = size;
            const ctx = c.getContext('2d');
            ctx.fillStyle = '#0b0f14';
            ctx.fillRect(0, 0, size, size);
            const g = ctx.createRadialGradient(size*0.35, size*0.35, size*0.1, size*0.5, size*0.5, size*0.7);
            g.addColorStop(0, '#0e1621');
            g.addColorStop(1, '#091118');
            ctx.fillStyle = g;
            ctx.beginPath();
            ctx.arc(size/2, size/2, size*0.44, 0, Math.PI*2);
            ctx.fill();
            // Minimal taxi bar
            ctx.fillStyle = '#f5c84b';
            ctx.fillRect(size*0.3, size*0.46, size*0.4, size*0.08);
            return c.toDataURL('image/png');
          };

          const icon192 = makeIcon(192);
          const icon512 = makeIcon(512);

          const manifest = {
            name: 'TaxiOMeter by Talbergh',
            short_name: 'TaxiOMeter',
            description: 'GPS-basierter Taxameter. Preis pro km festlegen, Fahrt starten, Route tracken, Preis berechnen.',
            start_url: (window.location.origin + window.location.pathname),
            display: 'standalone',
            orientation: 'portrait',
            background_color: '#0b0f14',
            theme_color: '#0b0f14',
            icons: [
              { src: icon192, sizes: '192x192', type: 'image/png', purpose: 'any maskable' },
              { src: icon512, sizes: '512x512', type: 'image/png', purpose: 'any maskable' }
            ]
          };
          const blob = new Blob([JSON.stringify(manifest)], { type: 'application/manifest+json' });
          const url = URL.createObjectURL(blob);
          const link = document.createElement('link');
          link.rel = 'manifest';
          link.href = url;
          document.head.appendChild(link);

          const apple = document.createElement('link');
          apple.rel = 'apple-touch-icon';
          apple.href = icon192;
          document.head.appendChild(apple);
        } catch (e) {
          console.warn('Manifest/Icon generation failed', e);
        }
      })();
    </script>
  </head>
  <body>
    <div id="app" class="app-shell">
      <header class="app-header safe-area-inset">
        <div class="brand">
          <i class="fa-solid fa-taxi logo" aria-hidden="true"></i>
          <h1>TaxiOMeter</h1>
          <span class="by">by Talbergh</span>
        </div>
        <button id="installBtn" class="ghost" hidden><i class="fa-solid fa-download"></i> Installieren</button>
      </header>

      <main id="views" class="views">
        <!-- Home View -->
        <section id="homeView" class="view active" aria-label="Home">
          <div class="panel map-panel">
            <div id="map" class="map" aria-label="Karte"></div>
            <div class="overlay top-right">
              <button id="locateBtn" class="icon-btn" title="Position zentrieren"><i class="fa-solid fa-location-crosshairs"></i></button>
            </div>
            <div class="overlay stats-bar">
              <div><span class="muted">km</span><strong id="distance">0.00</strong></div>
              <div><span class="muted">Zeit</span><strong id="duration">00:00:00</strong></div>
              <div><span class="muted">km/h</span><strong id="speed">0</strong></div>
              <div class="price"><span class="muted">Preis</span>€<strong id="price">0.00</strong></div>
            </div>
            <div class="overlay controls-bar">
              <div class="controls-row">
                <button id="startBtn" class="primary"><i class="fa-solid fa-play"></i> Start</button>
                <button id="pauseBtn" class="secondary" disabled><i class="fa-solid fa-pause"></i> Pause</button>
                <button id="resumeBtn" class="secondary" disabled><i class="fa-solid fa-play"></i> Weiter</button>
                <button id="stopBtn" class="danger" disabled><i class="fa-solid fa-stop"></i> Stop</button>
              </div>
              <p id="status" class="status" role="status">Bereit</p>
            </div>
          </div>
        </section>

        <!-- History View -->
        <section id="historyView" class="view" aria-label="Verlauf">
          <div class="panel list-panel">
            <ul id="historyList" class="list"></ul>
          </div>
        </section>

        <!-- Settings View -->
        <section id="settingsView" class="view" aria-label="Einstellungen">
          <div class="panel form-panel">
            <div class="form-row">
              <label for="rate">Preis pro km</label>
              <div class="input-affix">
                <input id="rate" type="number" inputmode="decimal" min="0" step="0.01" placeholder="1.50" />
                <span class="affix">€/km</span>
              </div>
            </div>
            <div class="form-row">
              <label>Auto-Zoom</label>
              <label class="switch">
                <input id="autoZoom" type="checkbox" checked />
                <span class="slider"></span>
              </label>
            </div>
            <div class="form-row">
              <label>Bildschirm an</label>
              <label class="switch">
                <input id="keepAwake" type="checkbox" checked />
                <span class="slider"></span>
              </label>
            </div>
            <div class="form-row">
              <label>Jitter-Filter (m)</label>
              <div class="input-affix">
                <input id="jitter" type="number" inputmode="numeric" min="0" step="1" placeholder="3" />
                <span class="affix">m</span>
              </div>
            </div>
          </div>
        </section>
      </main>

      <nav class="tabbar safe-area-inset">
        <button class="tab active" data-target="homeView"><i class="fa-solid fa-house"></i><span>Home</span></button>
        <button class="tab" data-target="historyView"><i class="fa-solid fa-clock-rotate-left"></i><span>Verlauf</span></button>
        <button class="tab" data-target="settingsView"><i class="fa-solid fa-gear"></i><span>Einstellungen</span></button>
      </nav>

      <!-- Start Ride Modal -->
      <dialog id="startModal" class="modal">
        <form method="dialog" class="modal-card">
          <h3>Fahrt starten</h3>
          <label for="rideName">Name (optional)</label>
          <input id="rideName" name="rideName" placeholder="z.B. Flughafen" />
          <div class="actions">
            <button value="cancel" class="ghost">Abbrechen</button>
            <button id="confirmStart" value="default" class="primary"><i class="fa-solid fa-play"></i> Start</button>
          </div>
        </form>
      </dialog>

      <!-- End Summary Modal -->
      <dialog id="endModal" class="modal">
        <form method="dialog" class="modal-card">
          <h3>Fahrt abgeschlossen</h3>
          <div class="grid-2">
            <div><span class="muted">Name</span><div id="mName">–</div></div>
            <div><span class="muted">Dauer</span><div id="mDuration">–</div></div>
            <div><span class="muted">Distanz</span><div><span id="mDistance">–</span> km</div></div>
            <div><span class="muted">Ø km/h</span><div id="mAvg">–</div></div>
          </div>
          <div class="price-box">
            <div class="row"><span class="muted">Grundpreis</span><strong>€<span id="mBasePrice">0.00</span></strong></div>
            <div class="row discount-row">
              <span class="muted">Rabatt</span>
              <div class="discount-inputs">
                <select id="discountMode">
                  <option value="none">Keiner</option>
                  <option value="percent">%</option>
                  <option value="amount">€</option>
                </select>
                <input id="discountValue" type="number" step="0.01" min="0" value="0" />
              </div>
            </div>
            <div class="row total"><span>Gesamt</span><strong>€<span id="mTotal">0.00</span></strong></div>
          </div>
          <div id="miniMap" class="mini-map" aria-label="Routenübersicht"></div>
          <div class="actions">
            <button id="shareBtn" class="secondary"><i class="fa-solid fa-share-nodes"></i> Teilen</button>
            <button id="resetBtn" class="ghost">Neu</button>
            <button value="close" class="primary">Fertig</button>
          </div>
        </form>
      </dialog>

      <!-- Onboarding Modal -->
      <dialog id="onboardingModal" class="modal">
        <form method="dialog" class="modal-card">
          <h3>Willkommen bei TaxiOMeter</h3>
          <ol class="steps">
            <li>Erlaube Standortzugriff für exaktes Tracking.</li>
            <li>Lege deinen Preis pro km unter Einstellungen fest.</li>
            <li>Starte eine Fahrt, optional mit Name, und folge der Karte.</li>
          </ol>
          <div class="actions">
            <button value="close" class="primary" id="onboardingOk"><i class="fa-solid fa-check"></i> Los geht’s</button>
          </div>
        </form>
      </dialog>

      <!-- Splash overlay -->
      <div id="splash" class="splash">
        <div class="splash-inner">
          <i class="fa-solid fa-taxi splash-icon"></i>
          <div class="splash-title">TaxiOMeter</div>
          <div class="splash-sub">by Talbergh</div>
        </div>
      </div>
    </div>

    <script src="./app.js" type="module"></script>
  </body>
  </html>
