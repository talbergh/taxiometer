
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="theme-color" content="#18181b">
  <meta name="description" content="TaxiOMeter - Digital Ride Receipt">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="assets/images/icon-192.png">
  <link rel="apple-touch-icon" href="assets/images/icon-192.png">
  <link rel="stylesheet" href="assets/stylesheets/app.css">
  <link rel="stylesheet" href="assets/stylesheets/leaflet.min.css">
  <link rel="stylesheet" href="assets/stylesheets/fontawesome.min.css">
  <script src="assets/javascripts/fontawesome.min.js" defer></script>
  <script src="assets/javascripts/leaflet.min.js"></script>
  <script src="assets/javascripts/jquery.min.js"></script>
  <script src="assets/javascripts/qrcode.min.js"></script>
  <title>TaxiOMeter - Digital Receipt</title>
</head>
<body class="landing-page">
  
  <main>
    <section class="card" id="receipt-card">
      <div style="text-align: center; margin-bottom: 2rem;">
        <h2><i class="fa-solid fa-taxi"></i></h2>
        <p style="color: var(--text-secondary);">this is your ride receipt</p>
      </div>
      
      <div id="ride-details">
        <!-- Ride details will be loaded here -->
        <div style="text-align: center; color: var(--text-secondary);">
          <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin: 2rem;"></i>
          <p>Loading receipt...</p>
        </div>
      </div>
      
      <div id="route-map" style="height: 200px; border-radius: var(--radius); margin: 1rem 0; display: none;">
        <!-- Map will be loaded here -->
      </div>
      
      <div style="text-align: center; margin-top: 2rem; padding-top: 1rem; border-top: 1px solid var(--border);">
        <p style="font-size: 0.8rem; color: var(--text-secondary);">
          Thank you for choosing our service!<br>
          Generated by TaxiOMeter made with love by Talbergh.
        </p>
      </div>
    </section>
    
    <section class="card">
      <h3>Actions</h3>
      <div class="btn-group">
        <button class="btn" id="download-receipt">
          <i class="fas fa-download icon"></i>Download Receipt
        </button>
        <button class="btn secondary" id="share-receipt">
          <i class="fas fa-share-nodes icon"></i>Share Receipt
        </button>
      </div>
    </section>
  </main>
  
  <footer style="margin-top: 2rem; text-align: center; padding: 2rem; color: var(--text-secondary);">
    <p>&copy; 2025 TaxiOMeter by Talbergh</p>
  </footer>
  
  <script type="module">
    import { QRModule } from './assets/javascripts/qr.js';
    
    let map = null;
    let rideData = null;
    
    function initMap() {
      if (!map) {
        map = L.map('route-map', {
          zoomControl: false,
          attributionControl: false
        });
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
        }).addTo(map);
      }
    }
    
    function displayRoute(coordinates) {
      if (!coordinates || coordinates.length === 0) return;
      
      document.getElementById('route-map').style.display = 'block';
      initMap();
      
      // Add route polyline
      const latLngs = coordinates.map(coord => [coord.lat, coord.lng]);
      const polyline = L.polyline(latLngs, {
        color: '#0a84ff',
        weight: 4,
        opacity: 0.8
      }).addTo(map);
      
      // Add start and end markers
      if (coordinates.length > 0) {
        L.marker([coordinates[0].lat, coordinates[0].lng])
          .bindPopup('Start')
          .addTo(map);
        
        L.marker([coordinates[coordinates.length - 1].lat, coordinates[coordinates.length - 1].lng])
          .bindPopup('End')
          .addTo(map);
      }
      
      // Fit map to route
      map.fitBounds(polyline.getBounds(), { padding: [20, 20] });
    }
    
    function displayRideDetails(ride) {
      const detailsContainer = document.getElementById('ride-details');
      
      const html = `
        <div style="text-align: center; margin: 2rem 0;">
          <div style="font-size: 3rem; font-weight: bold; color: var(--accent);">
            ${ride.fare.toFixed(2)}€
          </div>
          <div style="font-size: 1.1rem; color: var(--text-secondary);">
            Total Fare
          </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 2rem 0;">
          <div style="text-align: center;">
            <div style="font-size: 1.5rem; font-weight: bold;">${(ride.distance / 1000).toFixed(2)}</div>
            <div style="color: var(--text-secondary);">Kilometers</div>
          </div>
          <div style="text-align: center;">
            <div style="font-size: 1.5rem; font-weight: bold;">${Math.round(ride.duration / 60)}</div>
            <div style="color: var(--text-secondary);">Minutes</div>
          </div>
        </div>
        
        <div style="background: var(--primary); border-radius: var(--radius); padding: 1rem; margin: 1rem 0;">
          <h4 style="margin: 0 0 1rem 0;">Ride Details</h4>
          ${ride.name ? `<p><strong>Ride:</strong> ${ride.name}</p>` : ''}
          <p><strong>Date:</strong> ${new Date(ride.date).toLocaleString()}</p>
          <p><strong>Ride ID:</strong> #${ride.id}</p>
        </div>
      `;
      
      detailsContainer.innerHTML = html;
      
      // Display route if start/end coordinates are available
      if (ride.startCoords && ride.endCoords) {
        displayRoute([
          { lat: ride.startCoords[0], lng: ride.startCoords[1] },
          { lat: ride.endCoords[0], lng: ride.endCoords[1] }
        ]);
      } else if (ride.coordinates && ride.coordinates.length > 0) {
        // Fallback for old format
        displayRoute(ride.coordinates);
      }
    }
    
    function downloadReceipt() {
      if (!rideData) return;
      
      const receiptData = {
        rideName: rideData.name || 'Taxi Ride',
        date: new Date(rideData.date).toLocaleString(),
        distance: (rideData.distance / 1000).toFixed(2) + ' km',
        duration: Math.round(rideData.duration / 60) + ' minutes',
        fare: rideData.fare.toFixed(2) + '€',
        rideId: '#' + rideData.id.slice(-8)
      };
      
      const receiptText = `
TaxiOMeter Digital Receipt
========================
${receiptData.rideName}
Date: ${receiptData.date}
Distance: ${receiptData.distance}
Duration: ${receiptData.duration}
Total Fare: ${receiptData.fare}
Ride ID: ${receiptData.rideId}

Thank you for choosing our service!
Generated by TaxiOMeter
      `.trim();
      
      const blob = new Blob([receiptText], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `taxiometer-receipt-${rideData.id.slice(-8)}.txt`;
      a.click();
      URL.revokeObjectURL(url);
    }
    
    function shareReceipt() {
      if (!navigator.share) {
        alert('Web Share API not supported. Use download instead.');
        return;
      }
      
      if (!rideData) return;
      
      navigator.share({
        title: 'TaxiOMeter Receipt',
        text: `Taxi Ride Receipt\nFare: ${rideData.fare.toFixed(2)}€\nDistance: ${(rideData.distance/1000).toFixed(2)} km\nDuration: ${Math.round(rideData.duration/60)} min`,
        url: window.location.href
      });
    }
    
    // Load ride data from URL
    document.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      // Support both old 'data' parameter and new shorter 'r' parameter
      const encodedData = urlParams.get('r') || urlParams.get('data');
      
      if (encodedData) {
        rideData = QRModule.decodeRideData(encodedData);
        if (rideData) {
          displayRideDetails(rideData);
        } else {
          document.getElementById('ride-details').innerHTML = `
            <div style="text-align: center; color: var(--danger);">
              <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin: 2rem;"></i>
              <p>Invalid or corrupted receipt data.</p>
            </div>
          `;
        }
      } else {
        // Show sample receipt
        rideData = {
          id: 'sample123',
          name: 'Sample Ride',
          date: new Date().toISOString(),
          distance: 5500, // 5.5 km
          duration: 720, // 12 minutes
          fare: 12.50,
          coordinates: []
        };
        displayRideDetails(rideData);
      }
      
      // Set up event listeners
      document.getElementById('download-receipt').onclick = downloadReceipt;
      document.getElementById('share-receipt').onclick = shareReceipt;
    });
  </script>
</body>
</html>